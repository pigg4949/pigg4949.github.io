<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>지하철 역 정보</title>
    <style>
      #mapContainer {
        margin-top: 20px;
      }
      #map {
        width: 100%;
        height: 350px;
      }
      #mapCard {
        transition: transform 0.6s;
        transform-style: preserve-3d;
      }
      #info {
        padding: 10px;
      }
    </style>
  </head>
  <body>
    <label for="lineSelect">호선 선택:</label>
    <select id="lineSelect">
      <option value="">-- 호선을 선택하세요 --</option>
    </select>

    <label for="stationSelect">역 선택:</label>
    <select id="stationSelect" disabled>
      <option value="">-- 먼저 호선을 선택하세요 --</option>
    </select>

    <p id="status">데이터를 가져오는 중입니다.</p>
    <p>
      조회 및 설명 버튼이 작동하지 않을 경우, 역을 바꿨다 다시 선택해보세요!
    </p>

    <br /><br />
    <button id="searchButton" disabled>조회하기</button>
    <button id="infoButton" disabled>설명보기</button>

    <div id="mapContainer">
      <div id="mapCard">
        <div id="map"></div>
        <div id="info">설명 로딩중...</div>
      </div>
    </div>

    <!-- Kakao Map Script 동적 로드 -->
    <script>
      function loadKakaoMapScript(callback) {
        const script = document.createElement("script");
        script.src =
          "https://dapi.kakao.com/v2/maps/sdk.js?appkey=f4255232fc3c5b922233dca71510ac30&autoload=true&libraries=services";
        script.onload = callback;
        document.head.appendChild(script);
      }
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        loadKakaoMapScript(initApp);
      });

      function initApp() {
        const mapContainer = document.getElementById("map");
        const map = new kakao.maps.Map(mapContainer, {
          center: new kakao.maps.LatLng(37.5665, 126.978),
          level: 5,
        });

        const places = new kakao.maps.services.Places();
        let marker = null;

        const lineSelect = document.getElementById("lineSelect");
        const stationSelect = document.getElementById("stationSelect");
        const searchButton = document.getElementById("searchButton");
        const infoButton = document.getElementById("infoButton");

        fetch("https://proxy-server-ba6a.onrender.com/proxy")
          .then((res) => res.json())
          .then((data) => {
            const row = data.TbSeoulmetroStOrigin?.row;
            if (!row) throw new Error("데이터 형식 오류");

            // 고유 호선 목록 정렬 후 추가
            const lines = [...new Set(row.map((r) => r.SBWY_ROUT_LN))].sort();
            lines.forEach((line) => {
              const opt = document.createElement("option");
              opt.value = line;
              opt.textContent = line;
              lineSelect.appendChild(opt);
            });

            lineSelect.addEventListener("change", () => {
              stationSelect.innerHTML = "";
              const defaultOpt = document.createElement("option");
              defaultOpt.value = "";
              defaultOpt.textContent = "-- 역을 선택하세요 --";
              stationSelect.appendChild(defaultOpt);

              const selectedLine = lineSelect.value;
              if (!selectedLine) {
                stationSelect.disabled = true;
                searchButton.disabled = true;
                infoButton.disabled = true;
                return;
              }

              const filtered = row.filter(
                (r) => r.SBWY_ROUT_LN === selectedLine
              );
              const stations = [...new Set(filtered.map((r) => r.STTN))].sort();

              stations.forEach((station) => {
                const opt = document.createElement("option");
                opt.value = station;
                opt.textContent = station;
                stationSelect.appendChild(opt);
              });

              stationSelect.disabled = false;
              searchButton.disabled = false;
              infoButton.disabled = false;
              document.getElementById("status").textContent =
                "데이터 로딩 완료.";
            });

            searchButton.addEventListener("click", () => {
              const station = stationSelect.value;
              if (!station) return alert("역을 선택하세요.");

              places.keywordSearch(`${station}역`, (result, status) => {
                if (status === kakao.maps.services.Status.OK) {
                  const pos = new kakao.maps.LatLng(result[0].y, result[0].x);
                  map.setCenter(pos);
                  if (marker) marker.setMap(null);
                  marker = new kakao.maps.Marker({ map, position: pos });
                } else {
                  alert("지도를 찾을 수 없습니다.");
                }
              });
            });

            let flipped = false;
            infoButton.addEventListener("click", () => {
              const mapCard = document.getElementById("mapCard");
              flipped = !flipped;
              mapCard.style.transform = flipped
                ? "rotateY(180deg)"
                : "rotateY(0deg)";

              const station = stationSelect.value;
              const infoEl = document.getElementById("info");
              const desc =
                row.find((r) => r.STTN === station)?.STTN_ORGN ||
                "설명이 제공되지 않습니다.";
              infoEl.textContent = desc;
            });
          })
          .catch((err) => {
            console.error("데이터 오류:", err);
            document.getElementById("status").textContent =
              "데이터 불러오기 실패";
          });
      }
    </script>
  </body>
</html>
